#include "main.h"
#include "stm32f1xx_hal.h"
#include "ecran.h"

void LCD_Mode(uint8_t rs, uint8_t rw);
void LCD_write4bits(uint8_t data);

void LCD_Init(void)
{
	HAL_Delay(50);
	LCD_Mode(0, 0);
	LCD_write4bits(0x03);
	HAL_Delay(5);
	LCD_write4bits(0x03);
	HAL_Delay(5);
	LCD_write4bits(0x03);
	HAL_Delay(1);
	LCD_write4bits(0x02);

	LCD_command(0x28);
	LCD_command(0x08);
	LCD_command(0x01);
	LCD_command(0x06);
	HAL_Delay(2);

	return;
}

void LCD_Mode(uint8_t rs, uint8_t rw)
{
	// RS	Register Select	Choisit le registre cible (0 = commande, 1 = DDRAM)
	// RW	Read / Write	Choisit le sens du transfert (0 = ecriture, 1 = lecture)

	HAL_GPIO_WritePin(GPIOB, screen_rs_Pin, rs);
	HAL_GPIO_WritePin(GPIOB, screen_r_w_Pin, rw);

	return;
}

void LCD_write4bits(uint8_t data)
{
	HAL_GPIO_WritePin(GPIOB, screen_d4_Pin, (data & 0x01) ? GPIO_PIN_SET : GPIO_PIN_RESET);
	HAL_GPIO_WritePin(GPIOB, screen_d5_Pin, (data & 0x02) ? GPIO_PIN_SET : GPIO_PIN_RESET);
	HAL_GPIO_WritePin(GPIOB, screen_d6_Pin, (data & 0x04) ? GPIO_PIN_SET : GPIO_PIN_RESET);
	HAL_GPIO_WritePin(GPIOB, screen_d7_Pin, (data & 0x08) ? GPIO_PIN_SET : GPIO_PIN_RESET);

	HAL_GPIO_WritePin(GPIOB, screen_en_Pin, GPIO_PIN_SET);
	HAL_GPIO_WritePin(GPIOB, screen_en_Pin, GPIO_PIN_RESET);

	return;
}

void LCD_command(uint8_t data)
{
	LCD_Mode(0, 0);
	LCD_write4bits(data >> 4);
	LCD_write4bits(data & 0x0F);

	return;
}

void LCD_Char(uint8_t data)
{
	LCD_Mode(1, 0);
	LCD_write4bits(data >> 4);
	LCD_write4bits(data);

	return;
}
